{% extends 'layouts/car.html.twig' %}

{% block headerContent %}
    <header class="header" data-header>
        <div class="container">

            <div class="overlay" data-overlay></div>

            <a href="{{ url('app_home') }}" class="logo">
                <img src="{{ asset('assets/images/logo.png') }}" alt="Ridex logo">
            </a>

            <div class="header-actions">


                <a href="{{ url('app_home') }}" class="btn" aria-labelledby="aria-label-txt">
                    <span id="aria-label-txt">Accueil</span>
                </a>
                {% if app.user and is_granted('ROLE_ADMIN')%}
                    <ul class="admin-nav-ul">
                        <li class="admin-nav-li">
                            <a href="#" class="btn admin-nav-a" aria-labelledby="aria-label-txt ">Admin</a>
                            <ul class="admin-nav-ul">
                                <li class="admin-nav-li">
                                    <a href="{{ url('ajout_create') }}" class="btn admin-nav-a" aria-labelledby="aria-label-txt">
                                        <span class="aria-label-txt">Ajoutez Voiture</span>
                                    </a>
                                </li>
                                <li class="admin-nav-li">
                                    <a href="{{ url('createPhoto') }}" class="btn admin-nav-a" aria-labelledby="aria-label-txt">
                                        <span class="aria-label-txt">Ajout photo</span>
                                    </a>
                                </li>
                                <li class="admin-nav-li">
                                    <a href="{{ url('list_users') }}" class="btn admin-nav-a" aria-labelledby="aria-label-txt">
                                        <span class="aria-label-txt">Utilisateur</span>
                                    </a>
                                </li>
                                <li class="admin-nav-li">
                                    <a href="{{ url('article_list') }}" class="btn admin-nav-a" aria-labelledby="aria-label-txt">
                                        <span class="aria-label-txt">Article</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                {% endif %}
                {% if is_granted('ROLE_USER') or is_granted('ROLE_ADMIN') %}
                    {# Affiche le lien vers la page de profil sauf si l'utilisateur a ROLE_NOT et ROLE_USER #}
                    <a href="{{ url('profil') }}" class="btn user-btn" aria-label="Profile">
                        <ion-icon name="person-outline"></ion-icon>
                    </a>
                {% endif %}
                <a href="{{ url('app_contact') }}" class="btn" aria-labelledby="aria-label-txt">
                    <span id="aria-label-txt">Contact</span>
                </a>


                {% if is_granted('ROLE_USER') or is_granted('ROLE_ADMIN') or is_granted('ROLE_NOT') %}
                    <a href="{{ url('app_logout', {_target_path: path('app_login')}) }}" class="btn btn-red" aria-labelledby="aria-label-txt">
                        <span class="aria-label-txt">Déconnexion</span>
                    </a>
                {% else %}
                    <a href="{{ path('app_login') }}" class="btn btn-red" aria-labelledby="aria-label-txt">
                        <span class="aria-label-txt">Connexion</span>
                    </a>
                {% endif %}

                <button class="nav-toggle-btn" data-nav-toggle-btn aria-label="Toggle Menu">
                    <span class="one"></span>
                    <span class="two"></span>
                    <span class="three"></span>
                </button>

            </div>

        </div>
    </header>
{% endblock %}

{% block content %}
    <main>
        <section class="section featured-car" id="featured-car">
            <div class="container">

                <article>

                    <h3 class="h3 card-title space-title-profil">
                        Fiche technique
                    </h3>

                    <li>
                        <div class="featured-car-card">
                            <h3 class="h3 card-title ">
                                {{ link.category.name }} {{ link.title }}
                            </h3>
                            <figure class="card-banner">
                                <img src="{{ photoOrDefault(link) }}" alt="Forza" loading="lazy" width="440" height="300"
                                     class="w-100">
                            </figure>

                            <div class="card-content">

                                <div class="card-title-wrapper">
                                    <data class="year" value="2021">Année : {{ link.years }}</data>
                                </div>

                                <ul class="card-list">

                                    <li class="card-list-item">
                                        <ion-icon name="people-outline"></ion-icon>

                                        <span class="card-item-text">Nombre de personne : {{ link.maxPeople }}</span>
                                    </li>

                                    <li class="card-list-item">
                                        <ion-icon name="car-outline"></ion-icon>

                                        <span class="card-item-text">Type de voiture : {{ link.type }}</span>
                                    </li>

                                    <li class="card-list-item">
                                        <ion-icon name="speedometer-outline"></ion-icon>

                                        <span class="card-item-text">Chevaux : {{ link.consumption }}</span>
                                    </li>

                                    <li class="card-list-item">
                                        <ion-icon name="hardware-chip-outline"></ion-icon>

                                        <span class="card-item-text">Type de boite : µµ{{ link.box }}</span>
                                    </li>

                                </ul>

                                <div class="card-price-wrapper">
                                </div>

                            </div>
                        </div>
                    </li>

                </article>
                <!-- Add more output for other article properties -->

                <h2 class="h2 section-title space-title-profil">Commentaire</h2>
                <!-- Affichage des commentaires existants -->
                <ol class="commentlist">
                    {% for comment in link.comments %}
                        <li>
                            <div>
                                <cite>{{ comment.author.email }}</cite>
                            </div>
                            <div>
                                <p>{{ comment.comment }}</p>
                            </div>
                        </li>
                    {% endfor %}
                </ol>

                <h3>Ajouter un commentaire</h3>
                <div id="commentForm" data-comments-url="{{ url('get_blogPost_comment',{id: link.id}) }}">
                    {{ form(commentForm) }}
                </div>

            </div>
        </section>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.querySelectorAll('.thumbLink')
            .forEach(link => {
                link.addEventListener('click', e => {
                    document.getElementById("bigPhoto").src = e.target.src;
                });
            });
    </script>
    <script>
        document.querySelector("#commentForm form")
            .addEventListener('submit', e => {
                e.preventDefault();

                const data = new URLSearchParams(new FormData(e.target));

                const targetUrl = e.target.getAttribute('action');
                fetch(targetUrl, {
                    method: 'post',
                    body: data,
                }).then( response =>{
                    refreshComments(e.target.parentElement.getAttribute('data-comments-url'))} );
            })
        function refreshComments(commentsUrl) {
            fetch(commentsUrl)
                .then(response => response.json())
                .then(comments =>{
                    comments =JSON.parse(comments);
                    let commentsElements = '';
                comments.forEach(comment => {
                    let commentElement = ''+
                        '<li>'+
                        '<div>'+
                            '<cite>' +comment.author.email+
                        '</cite>'+
                        '</div>'+
                        '<div>'+
                        '<p>'+ comment.comment + '</p>'+
                        '</div>'+
                    '</li>'
                    commentsElements += commentElement;
                });
                    document.querySelector('.commentlist').innerHTML=commentsElements;
        })
        }

    </script>

{% endblock javascripts %}
