{% extends 'base.html.twig' %}

{% block title %}Groupes de {{ user.username }}{% endblock %}

{% block body %}
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">Groupes de <span class="text-primary">{{ user.username }}</span></h2>
            <a href="{{ path('task_admin') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour Admin
            </a>
        </div>

        {% if groups is empty %}
            <div class="alert alert-info">Cet utilisateur n’a pas encore de groupe.</div>
        {% endif %}

        <div class="accordion" id="userGroupsAccordion">
            {% for g in groups %}
                {% set total = g.tasks|length %}
                {% set done  = g.tasks|filter(t => t.status == 'terminee')|length %}
                {% set todo  = total - done %}

                <div class="card mb-3 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <button class="btn btn-link text-decoration-none text-start w-100"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#grp-{{ g.id }}"
                                aria-expanded="false"
                                aria-controls="grp-{{ g.id }}">
                            {% if g.color %}
                                <span class="badge me-2" style="background:{{ g.color }}">&nbsp;</span>
                            {% endif %}
                            <strong>{{ g.name }}</strong>
                            <span class="ms-2 text-muted small">
              • {{ total }} tâches • {{ done }} terminées • {{ todo }} à faire
            </span>
                        </button>
                        <i class="bi bi-chevron-down ms-2"></i>
                    </div>

                    <div id="grp-{{ g.id }}" class="collapse" data-bs-parent="#userGroupsAccordion">
                        <div class="card-body">
                            {% if total == 0 %}
                                <p class="text-muted mb-0">Aucune tâche dans ce groupe.</p>
                            {% else %}
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                        <tr>
                                            <th scope="col">#ID</th>
                                            <th scope="col">Titre</th>
                                            <th scope="col">Échéance</th>
                                            <th scope="col">Priorité</th>
                                            <th scope="col">Statut</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for task in g.tasks %}
                                            <tr class="{% if task.status == 'terminee' %}table-success{% elseif task.status == 'en_cours' %}table-warning{% else %}table-light{% endif %}">
                                                <td class="fw-semibold">{{ task.id }}</td>
                                                <td>{{ task.title }}</td>
                                                <td>{{ task.dueDate ? task.dueDate|date('d/m/Y') : '—' }}</td>
                                                <td>
                        <span class="{% if task.priority == 'élevée' %}text-danger{% elseif task.priority == 'moyenne' %}text-warning{% else %}text-info{% endif %}">
                          {{ task.priority|capitalize }}
                        </span>
                                                </td>
                                                <td>
                                                    {% if task.status == 'terminee' %}
                                                        <span class="badge rounded-pill bg-success">Terminée</span>
                                                    {% elseif task.status == 'en_cours' %}
                                                        <span class="badge rounded-pill bg-warning text-dark">En cours</span>
                                                    {% else %}
                                                        <span class="badge rounded-pill bg-secondary">Non commencée</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <script>
        (function(){
            const key = 'admin_open_groups_user_{{ user.id }}';
            const opened = new Set((document.cookie.match(new RegExp('(?:^|; )'+key+'=([^;]*)'))?.[1] || '').split(',').filter(Boolean));

            // restaurer l'état
            opened.forEach(id => {
                const el = document.getElementById('grp-'+id);
                if (el) new bootstrap.Collapse(el, { toggle: true });
            });

            // écouter open/close
            document.querySelectorAll('[id^="grp-"]').forEach(el => {
                el.addEventListener('shown.bs.collapse', e => {
                    opened.add(el.id.replace('grp-',''));
                    document.cookie = key + '=' + Array.from(opened).join(',') + '; path=/; max-age=' + (60*60*24*30) + '; samesite=Lax';
                });
                el.addEventListener('hidden.bs.collapse', e => {
                    opened.delete(el.id.replace('grp-',''));
                    document.cookie = key + '=' + Array.from(opened).join(',') + '; path=/; max-age=' + (60*60*24*30) + '; samesite=Lax';
                });
            });
        })();
    </script>
{% endblock %}


